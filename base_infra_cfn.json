{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "A CloudFormation template that will provision a new VPC and associated VPC resources for the re:Invent 2017 workshop. This template is provided as-is with no guarantee of support.",

  "Parameters" : {

    "Keypair" : {
      "Description" : "Key Pair to enable ssh access to Bastian Host",
      "Type" : "AWS::EC2::KeyPair::KeyName"
    },

    "AmazonLinuxAMI" : {
      "Description" : "ID of Amazon Linux AMI to be used in this workshop.",
      "Type" : "AWS::EC2::Image::Id",
      "Default" : "ami-01ccc867"
    }
  },

  "Resources" : {
    "VPC" : {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "CidrBlock" : "192.168.0.0/22",
        "EnableDnsHostnames" : "true",
        "Tags" : [ {"Key" : "Name", "Value" : "GAM310 VPC" } ]
      }
    },

    "SubnetA" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "AvailabilityZone" : "us-west-2a",
        "CidrBlock" : "192.168.0.0/24",
        "MapPublicIpOnLaunch" : "true",
        "Tags" : [ {"Key" : "Name", "Value" : "GAM310 - Subnet A" } ]
      }
    },

    "SubnetB" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "AvailabilityZone" : "us-west-2b",
        "CidrBlock" : "192.168.1.0/24",
        "MapPublicIpOnLaunch" : "true",
        "Tags" : [ {"Key" : "Name", "Value" : "GAM310 - Subnet B" } ]
      }
    },

    "SubnetC" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "AvailabilityZone" : "us-west-1c",
        "CidrBlock" : "192.168.2.0/24",
        "MapPublicIpOnLaunch" : "true",
        "Tags" : [ {"Key" : "Name", "Value" : "GAM310 - Subnet C" } ]
      }
    },

    "InternetGateway" : {
      "Type" : "AWS::EC2::InternetGateway",
      "Properties" : {
        "Tags" : [ {"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} } ]
      }
    },

    "AttachGateway" : {
       "Type" : "AWS::EC2::VPCGatewayAttachment",
       "Properties" : {
         "VpcId" : { "Ref" : "VPC" },
         "InternetGatewayId" : { "Ref" : "InternetGateway" }
       }
    },

    "RouteTable" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : {"Ref" : "VPC"},
        "Tags" : [ {"Key" : "Name", "Value" : "GAM310 - Route Table" } ]
      }
    },

    "Route" : {
      "Type" : "AWS::EC2::Route",
      "DependsOn" : "AttachGateway",
      "Properties" : {
        "RouteTableId" : { "Ref" : "RouteTable" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "GatewayId" : { "Ref" : "InternetGateway" }
      }
    },

    "SubnetRouteTableAssociationA" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "SubnetA" },
        "RouteTableId" : { "Ref" : "RouteTable" }
      }
    },

    "SubnetRouteTableAssociationB" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "SubnetB" },
        "RouteTableId" : { "Ref" : "RouteTable" }
      }
    },

    "SubnetRouteTableAssociationC" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "SubnetC" },
        "RouteTableId" : { "Ref" : "RouteTable" }
      }
    },

    "SecurityGroupEC2" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupName" : "GAM310 - Bastian Host Security Group",
        "GroupDescription" : "Security group that governs access to the Bastian host used in the Workshop",
        "SecurityGroupIngress" : [
          {
            "IpProtocol" : "tcp",
            "FromPort" : "22",
            "ToPort" : "22",
            "CidrIp" : "0.0.0.0/0"
          }
        ],
        "VpcId" : {"Ref" : "VPC"}
      }
    },

    "SecurityGroupRedshift" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupName" : "GAM310 - Redshift Cluster Security Group",
        "GroupDescription" : "Security group that governs access to the Redshift Cluster used in the Workshop",
        "SecurityGroupIngress" : [
          {
            "IpProtocol" : "tcp",
            "FromPort" : "5439",
            "ToPort" : "5439",
            "CidrIp" : "0.0.0.0/0"
          },
          {
            "IpProtocol" : "tcp",
            "FromPort" : "8192",
            "ToPort" : "8192",
            "CidrIp" : "0.0.0.0/0"
          }
        ],
        "VpcId" : {"Ref" : "VPC"}
      }
    },

    "BastianHostEC2Instance" : {
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "BlockDeviceMappings" : [
          {
            "DeviceName" : "/dev/xvda",
            "Ebs" : {
              "VolumeType" : "gp2",
              "DeleteOnTermination" : "true",
              "VolumeSize" : "8"
            }
          }
        ],
        "IamInstanceProfile" : { "Ref" : "JenkinsInstanceProfile" },
        "ImageId" : { "Ref" : "ami-04c1097c" },
        "InstanceType" : "t2.micro",
        "KeyName" : { "Ref" : "Keypair" },
        "SecurityGroupIds" : [
          { "Ref" : "SecurityGroupEC2" }
        ],
        "SubnetId" : { "Ref" : "SubnetA", "SubnetB", "SubnetC" },
        "Tags" : [
          { "Key" : "Name", "Value" : "Bastian Host (On-demand)" }
        ],
        "UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
          "#!/bin/bash\n",
          "# Install all pending updates to the system\n",
          "yum -y update\n",
          "cd /home/ec2-user\n"
          "git clone https://github.com/niravdd/myWork.git\n"
        ]]}}
      }
    },

  "Outputs" : {

    "DeploymentArtifactS3BucketName" : {
      "Description" : "Name of the S3 Bucket where deployment artifacts will be uploaded to",
      "Value" : { 
        "Ref" : "DeploymentArtifactS3Bucket"
      }
    },

    "VPC ID" : {
      "Description" : "VPC ID",
      "Value" : {
        "Fn::GetAtt" : [ "VPC", "VpcId" ]
      }
    },

    "SubnetA" : {
      "Description" : "Subnet in us-west-2a",
      "Value" : {
        "Fn::GetAtt" : [ "SubnetA", "SubnetId" ]
      }
    },

    "SubnetB" : {
      "Description" : "Subnet in us-west-2b",
      "Value" : {
        "Fn::GetAtt" : [ "SubnetB", "SubnetId" ]
      }
    },

    "SubnetC" : {
      "Description" : "Subnet in us-west-2c",
      "Value" : {
        "Fn::GetAtt" : [ "SubnetC", "SubnetId" ]
      }
    },

    "BastianHostInstance" : {
      "Description" : "Bastian Host ID",
      "Value" : {
        "Fn::GetAtt" : [ "BastianHostEC2Instance", "PublicIP" ]
      }
    }
  }
}
